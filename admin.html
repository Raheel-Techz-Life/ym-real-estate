<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Dashboard | Y M REAL ESTATE</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <style>
    /* --- NAVY BLUE THEME --- */
    :root { 
        --primary: #263f6e;
        --accent: #ffd700;
        --bg-gradient: linear-gradient(135deg, #f6faff 0%, #e8f0fe 100%);
        --danger: #ef4444;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Arial, sans-serif; }
    body { background: var(--bg-gradient); color: #333; min-height: 100vh; padding-bottom: 60px; }

    /* HEADER */
    .header { background: var(--primary); color: #fff; padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
    .logo-area { display: flex; align-items: center; gap: 10px; color: white; text-decoration: none; font-weight: bold; font-size: 1.2rem; }
    .nav { display: flex; gap: 15px; }
    .nav button { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 15px; border-radius: 5px; cursor: pointer; transition: 0.2s; }
    .nav button:hover { background: rgba(255,255,255,0.3); }

    /* LAYOUT */
    .container { max-width: 1000px; margin: 40px auto; padding: 0 20px; }
    
    .card { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 30px; border: 1px solid #eef2ff; }
    .card.editing { border: 2px solid var(--accent); background: #fffcf0; position: relative; }
    .card.editing::before { content:'EDITING MODE'; position:absolute; top:0; right:0; background:var(--accent); font-size:0.7rem; font-weight:bold; padding:4px 10px; border-bottom-left-radius:8px; }

    h2 { color: var(--primary); margin-bottom: 20px; font-size: 1.5rem; }
    
    /* FORM */
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .full { grid-column: 1 / -1; }
    .form-group label { display: block; margin-bottom: 5px; color: var(--primary); font-weight: 600; font-size: 0.9rem; }
    .form-group input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 0.95rem; }
    
    /* IMAGES */
    .upload-box { border: 2px dashed #ccc; padding: 30px; text-align: center; cursor: pointer; background: #fafafa; border-radius: 8px; transition: 0.3s; }
    .upload-box:hover { border-color: var(--primary); background: #eef2ff; }
    .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 15px; }
    .thumb { width: 100%; height: 100px; object-fit: cover; border-radius: 6px; border: 1px solid #ddd; }
    .thumb-wrap { position: relative; }
    .del-img { position: absolute; top: 2px; right: 2px; background: rgba(255,255,255,0.9); color: red; border: none; width: 22px; height: 22px; border-radius: 50%; cursor: pointer; font-weight:bold; }

    /* LIST */
    .list-item { display: flex; background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ddd; align-items: center; gap: 15px; transition:0.2s; }
    .list-item:hover { transform:translateY(-2px); box-shadow:0 5px 15px rgba(0,0,0,0.05); }
    .list-img { width: 80px; height: 60px; object-fit: cover; border-radius: 4px; background: #eee; }
    .list-info { flex: 1; }
    .list-title { font-weight: bold; color: var(--primary); font-size: 1.1rem; }
    .btn-action { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; margin-left: 5px; font-weight:600; }
    .btn-edit { background: #e0e7ff; color: var(--primary); }
    .btn-del { background: #fee2e2; color: var(--danger); }
    
    .btn-primary { background: var(--primary); color: white; padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight:600; }
    .btn-cancel { background: #fff; border: 1px solid #ccc; color: #666; padding: 12px 25px; border-radius: 6px; cursor: pointer; display: none; margin-right: 10px; }
    
    @media(max-width:700px){ .header{flex-direction:column; gap:10px;} .grid{grid-template-columns:1fr;} }
  </style>
</head>
<body>

<div class="header">
    <a href="index.html" class="logo-area"><i class="fas fa-user-shield"></i> ADMIN PANEL</a>
    <div class="nav">
        <button onclick="window.location.href='index.html'">View Website</button>
        <button onclick="logout()" style="background:rgba(239,68,68,0.2); color:#ffcece;">Logout</button>
    </div>
</div>

<div class="container">

    <div class="card" id="formCard">
        <h2 id="formTitle"><i class="fas fa-plus-circle"></i> Add Property</h2>
        
        <div class="grid">
            <div class="form-group"><label>Title</label><input id="title"></div>
            <div class="form-group"><label>Price (₹)</label><input id="price" type="number"></div>
            <div class="form-group"><label>Type</label>
                <select id="propertyType"><option>House</option><option>Villa</option><option>Plot</option><option>Apartment</option><option>Shop</option></select>
            </div>
            <div class="form-group"><label>City</label><input id="city"></div>
            <div class="form-group"><label>Area (sqft)</label><input id="area"></div>
            <div class="form-group"><label>Bedrooms</label><input id="bedrooms"></div>
            <div class="form-group"><label>Bathrooms</label><input id="bathrooms"></div>
            <div class="form-group"><label>Parking</label><select id="parking"><option value="true">Yes</option><option value="false">No</option></select></div>
        </div>
        <div class="form-group full" style="margin-top:15px"><label>Description</label><textarea id="description"></textarea></div>
        <div class="form-group full"><label>Amenities</label><input id="propAmenities" placeholder="Wifi, Pool, Gym..."></div>
        
        <input type="hidden" id="ownerName"><input type="hidden" id="ownerPhone"><input type="hidden" id="ownerEmail">

        <div style="margin-top:20px;">
            <div class="upload-box" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-cloud-upload-alt" style="font-size:2rem; color:#ccc;"></i><br>
                Click to Upload Images from Device
            </div>
            <input type="file" id="fileInput" multiple accept="image/*" style="display:none;" onchange="handleFiles(event)">
            <div class="gallery" id="gallery"></div>
        </div>

        <div style="margin-top:20px; text-align:right;">
            <button class="btn-cancel" id="cancelBtn" onclick="resetForm()">Cancel</button>
            <button class="btn-primary" id="saveBtn" onclick="saveProperty()">Save Property</button>
        </div>
    </div>

    <h2 style="display:flex; justify-content:space-between; align-items:center;">
        Current Listings 
        <button class="btn-action btn-edit" onclick="loadProps()" style="font-size:0.9rem;">Refresh</button>
    </h2>
    <div id="list"></div>
</div>

<script>
    // --- 1. CONNECTION ---
    const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    const API = isLocal ? 'http://localhost:5011' : 'https://ym-real-estate.onrender.com';

    // --- 2. IMAGE FIXER (Direct Uploads) ---
    function getImgUrl(path) {
        if (!path) return 'https://placehold.co/100?text=No+Img';
        if (path.startsWith('http')) return path;
        
        // This takes "C:\fakepath\image.jpg" and keeps only "image.jpg"
        const filename = path.split(/[/\\]/).pop();
        // Returns "http://localhost:5011/uploads/image.jpg"
        return `${API}/uploads/${filename}`;
    }

    let user = null;
    let editId = null;
    let oldImgs = [];
    let newFiles = [];

    // --- 3. KEYWORD ACCESS LOGIC ---
    window.onload = () => {
        const u = localStorage.getItem('user');
        if(!u) return window.location.href = 'login.html';
        
        user = JSON.parse(u);
        const email = (user.email || "").toLowerCase();
        const role = (user.role || "").toLowerCase();

        // KEYWORD CHECK:
        const keywords = ['team', 'test', 'tester', 'ym'];
        const isTester = keywords.some(k => email.includes(k));

        // If NOT admin/team AND NOT a tester/ym email -> Kick out
        if (role !== 'admin' && role !== 'team' && !isTester) {
            alert("Access Denied. You are not recognized as a team member or tester.");
            window.location.href = 'index.html';
            return;
        }

        console.log("Access Granted. User:", email);

        // Fill Agent Info
        document.getElementById('ownerName').value = user.name || 'YM Agent';
        document.getElementById('ownerEmail').value = user.email || 'info@ymrealestate.com';
        document.getElementById('ownerPhone').value = user.phone || '9999999999';

        loadProps();
    };

    function logout() { localStorage.clear(); window.location.href = 'index.html'; }

    // --- 4. IMAGES ---
    function handleFiles(e) { newFiles = [...newFiles, ...e.target.files]; renderGallery(); }
    
    function renderGallery() {
        const g = document.getElementById('gallery'); g.innerHTML = '';
        oldImgs.forEach((url, i) => {
            g.innerHTML += `<div class="thumb-wrap"><img src="${getImgUrl(url)}" class="thumb"><button class="del-img" onclick="delOld(${i})">x</button></div>`;
        });
        newFiles.forEach((f, i) => {
            g.innerHTML += `<div class="thumb-wrap"><img src="${URL.createObjectURL(f)}" class="thumb"><button class="del-img" onclick="delNew(${i})">x</button></div>`;
        });
    }
    
    function delOld(i) { oldImgs.splice(i,1); renderGallery(); }
    function delNew(i) { newFiles.splice(i,1); renderGallery(); }

    // --- 5. SAVE ---
    async function saveProperty() {
        const btn = document.getElementById('saveBtn'); btn.innerText = "Saving..."; btn.disabled = true;
        
        try {
            const token = localStorage.getItem('token');
            let uploadedUrls = [];

            if(newFiles.length > 0) {
                const fd = new FormData();
                newFiles.forEach(f => fd.append('images', f));
                const res = await fetch(`${API}/api/upload`, { method:'POST', headers:{'Authorization':`Bearer ${token}`}, body:fd });
                const d = await res.json();
                if(d.success) uploadedUrls = d.urls;
            }

            const data = {
                title: val('title'), price: val('price'), propertyType: val('propertyType'),
                description: val('description'),
                amenities: val('propAmenities').split(','),
                address: { city: val('city') },
                features: { area: val('area'), bedrooms: val('bedrooms'), bathrooms: val('bathrooms'), parking: val('parking')==='true' },
                owner: { name: val('ownerName'), phone: val('ownerPhone'), email: val('ownerEmail') },
                images: [...oldImgs, ...uploadedUrls]
            };

            const url = editId ? `${API}/api/properties/${editId}` : `${API}/api/properties`;
            const method = editId ? 'PUT' : 'POST';

            const res = await fetch(url, { method, headers:{'Content-Type':'application/json', 'Authorization':`Bearer ${token}`}, body:JSON.stringify(data)});
            
            if(res.ok) { alert("Saved Successfully!"); resetForm(); loadProps(); } 
            else { alert("Error saving property."); }

        } catch(e) { console.error(e); alert("Backend Connection Failed"); }
        finally { btn.innerText = "Save Property"; btn.disabled = false; }
    }

    // --- 6. LOAD ---
    async function loadProps() {
        const list = document.getElementById('list'); list.innerHTML = "<p>Loading...</p>";
        try {
            const res = await fetch(`${API}/api/properties`);
            const d = await res.json();
            const items = d.data || d;
            
            if(!items.length) { list.innerHTML = "<p>No properties found.</p>"; return; }

            list.innerHTML = items.map(p => `
                <div class="list-item">
                    <img src="${getImgUrl(p.images?.[0])}" class="list-img">
                    <div class="list-info">
                        <div class="list-title">${p.title}</div>
                        <div style="color:#666; font-size:0.9rem;">${p.propertyType} • ₹${Number(p.price).toLocaleString()}</div>
                    </div>
                    <div>
                        <button class="btn-action btn-edit" onclick="edit('${encodeURIComponent(JSON.stringify(p))}')">Edit</button>
                        <button class="btn-action btn-del" onclick="del('${p._id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        } catch(e) { list.innerHTML = "<p style='color:red'>Error connecting to backend.</p>"; }
    }

    // --- HELPERS ---
    function val(id) { return document.getElementById(id).value; }
    
    function edit(str) {
        const p = JSON.parse(decodeURIComponent(str));
        editId = p._id;
        
        document.getElementById('title').value = p.title;
        document.getElementById('price').value = p.price;
        document.getElementById('propertyType').value = p.propertyType;
        document.getElementById('city').value = p.address?.city || '';
        document.getElementById('area').value = p.features?.area || '';
        document.getElementById('bedrooms').value = p.features?.bedrooms || '';
        document.getElementById('bathrooms').value = p.features?.bathrooms || '';
        document.getElementById('parking').value = p.features?.parking ? 'true' : 'false';
        document.getElementById('description').value = p.description;
        document.getElementById('propAmenities').value = p.amenities?.join(',') || '';
        
        oldImgs = p.images || []; newFiles = []; renderGallery();
        
        document.getElementById('formCard').classList.add('editing');
        document.getElementById('formTitle').innerText = "Edit Property";
        document.getElementById('saveBtn').innerText = "Update Property";
        document.getElementById('cancelBtn').style.display = "inline-block";
        window.scrollTo(0,0);
    }

    function resetForm() {
        editId = null;
        document.getElementById('formCard').classList.remove('editing');
        document.getElementById('formTitle').innerText = "Add Property";
        document.getElementById('saveBtn').innerText = "Save Property";
        document.getElementById('cancelBtn').style.display = "none";
        document.querySelectorAll('input:not([type=hidden]), textarea').forEach(i => i.value = '');
        oldImgs=[]; newFiles=[]; renderGallery();
    }

    async function del(id) {
        if(confirm("Delete this property?")) {
            await fetch(`${API}/api/properties/${id}`, { method:'DELETE', headers:{'Authorization':`Bearer ${localStorage.getItem('token')}`} });
            loadProps();
        }
    }
</script>
</body>
</html>
