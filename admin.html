<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Dashboard - YM Real Estate</title>
  <style>
    body{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;margin:0;background:#f0f2f5;color:#1a1a1a}
    .wrap{max-width:1000px;margin:30px auto;padding:20px}
    h1{color:#2c3e50;margin-bottom:20px;border-bottom:2px solid #3498db;padding-bottom:10px}
    
    /* Login Warning */
    #auth-warning {display:none; text-align:center; padding:50px; background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1);}
    #admin-panel {display:none;}

    .form{background:#fff;padding:25px;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.05); margin-bottom:30px;}
    .row{display:flex;gap:15px;margin-bottom:15px; flex-wrap:wrap;}
    .form-group {flex:1; min-width: 200px;}
    label{display:block; font-weight:600; margin-bottom:5px; color:#34495e;}
    input[type=text], input[type=number], select, textarea{
        width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box; font-size:14px;
    }
    textarea{min-height:100px; resize:vertical;}
    
    button{background:#3498db;color:#fff;padding:12px 20px;border:0;border-radius:6px;cursor:pointer;font-weight:600;transition:0.2s;}
    button:hover{background:#2980b9;}
    button.delete{background:#e74c3c;}
    button.delete:hover{background:#c0392b;}

    .list-header {display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;}
    .card{background:#fff;padding:15px;border-radius:8px;margin-bottom:15px;display:flex;gap:15px;align-items:center;box-shadow:0 2px 4px rgba(0,0,0,0.05);}
    .card img{width:100px;height:70px;object-fit:cover;border-radius:4px;background:#eee;}
    .meta{flex:1;}
    .meta h3 {margin:0 0 5px 0; font-size:16px;}
    .controls{display:flex;gap:10px;}

    /* Status Badge */
    .status {padding:4px 8px; border-radius:12px; font-size:12px; font-weight:bold;}
    .status.sale {background:#e8f8f5; color:#27ae60;}
    .status.rent {background:#fef9e7; color:#f1c40f;}

    /* Loading Spinner */
    #loading {position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:none; justify-content:center; align-items:center; z-index:999;}
    .spinner {border:4px solid #f3f3f3; border-top:4px solid #3498db; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite;}
    @keyframes spin {0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)}}
  </style>
</head>
<body>

  <div id="loading"><div class="spinner"></div></div>

  <div class="wrap">
    <div id="auth-warning">
      <h2>ðŸ”’ Admin Access Required</h2>
      <p>You must be logged in as an admin to view this page.</p>
      <button onclick="window.location.href='login.html'">Go to Login</button>
    </div>

    <div id="admin-panel">
      <h1>Admin Dashboard</h1>
      
      <div class="form">
        <h3>Add New Property</h3>
        <div class="row">
            <div class="form-group">
                <label>Property Title*</label>
                <input id="title" type="text" placeholder="e.g. Luxury Villa in Goa">
            </div>
            <div class="form-group">
                <label>Price (â‚¹)*</label>
                <input id="price" type="number" placeholder="e.g. 25000000">
            </div>
        </div>

        <div class="row">
            <div class="form-group">
                <label>Type</label>
                <select id="propertyType">
                    <option value="Apartment">Apartment</option>
                    <option value="Villa">Villa</option>
                    <option value="Office">Office</option>
                    <option value="Land">Land</option>
                </select>
            </div>
            <div class="form-group">
                <label>Status</label>
                <select id="status">
                    <option value="sale">For Sale</option>
                    <option value="rent">For Rent</option>
                </select>
            </div>
        </div>

        <div class="row">
            <div class="form-group">
                <label>Location (City)*</label>
                <input id="city" type="text" placeholder="e.g. Mumbai">
            </div>
            <div class="form-group">
                <label>Area (Sq Ft)</label>
                <input id="area" type="number" placeholder="e.g. 1200">
            </div>
        </div>

        <div class="row">
            <div class="form-group">
                <label>Description*</label>
                <textarea id="description" placeholder="Full property details..."></textarea>
            </div>
        </div>

        <div class="row">
            <div class="form-group">
                <label>Image Upload</label>
                <input id="imageFile" type="file" accept="image/*" multiple>
            </div>
        </div>

        <div style="text-align:right">
            <button id="saveBtn" onclick="saveProperty()">Save Property</button>
        </div>
      </div>

      <div class="list">
        <div class="list-header">
            <h2>Manage Listings</h2>
            <button onclick="loadProperties()" style="background:#95a5a6; padding:8px 12px; font-size:12px;">Refresh</button>
        </div>
        <div id="items">Loading properties...</div>
      </div>
    </div>
  </div>

  <script>
    // --- CONFIGURATION ---
    const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
        ? 'http://localhost:5011/api'  // Your local backend port
        : 'https://ym-real-estate.onrender.com/api'; // Your Render backend

    // --- STATE ---
    let currentUser = null;
    let editingId = null;

    // --- INITIALIZATION ---
    window.onload = checkAuth;

    function checkAuth() {
        const token = localStorage.getItem('token');
        const userStr = localStorage.getItem('user');
        
        if (!token || !userStr) {
            showLoginWarning();
            return;
        }

        try {
            currentUser = JSON.parse(userStr);
            // Simple role check (Backend will do the real security check)
            if (currentUser.role !== 'admin' && currentUser.role !== 'team') {
                alert("Access Denied: You are not an admin.");
                window.location.href = 'index.html';
                return;
            }
            // Show Admin Panel
            document.getElementById('auth-warning').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
            loadProperties();
        } catch (e) {
            showLoginWarning();
        }
    }

    function showLoginWarning() {
        document.getElementById('auth-warning').style.display = 'block';
        document.getElementById('admin-panel').style.display = 'none';
    }

    // --- API FUNCTIONS ---

    async function loadProperties() {
        const itemsEl = document.getElementById('items');
        itemsEl.innerHTML = '<p style="text-align:center; color:#777;">Fetching data...</p>';

        try {
            const res = await fetch(`${API_URL}/properties`);
            const json = await res.json();

            if (!json.success) throw new Error(json.error);

            itemsEl.innerHTML = '';
            if (json.data.length === 0) {
                itemsEl.innerHTML = '<p>No properties found.</p>';
                return;
            }

            json.data.forEach(p => {
                const div = document.createElement('div');
                div.className = 'card';
                // Use first image or placeholder
                const imgUrl = (p.images && p.images.length > 0) ? p.images[0] : 'https://via.placeholder.com/150';
                
                div.innerHTML = `
                    <img src="${imgUrl}" alt="Property">
                    <div class="meta">
                        <h3>${p.title} <span class="status ${p.status}">${p.status.toUpperCase()}</span></h3>
                        <div class="note">â‚¹${p.price.toLocaleString()} â€¢ ${p.address.city}</div>
                    </div>
                    <div class="controls">
                        <button class="delete" onclick="deleteProperty('${p._id}')">Delete</button>
                    </div>
                `;
                itemsEl.appendChild(div);
            });
        } catch (err) {
            console.error(err);
            itemsEl.innerHTML = `<p style="color:red">Error loading properties: ${err.message}</p>`;
        }
    }

    async function saveProperty() {
        const token = localStorage.getItem('token');
        if (!token) return alert("Session expired. Please login again.");

        // 1. Get Form Values
        const title = document.getElementById('title').value;
        const price = document.getElementById('price').value;
        const type = document.getElementById('propertyType').value;
        const status = document.getElementById('status').value;
        const city = document.getElementById('city').value;
        const desc = document.getElementById('description').value;
        const area = document.getElementById('area').value;
        const imageInput = document.getElementById('imageFile');

        // Validation
        if (!title || !price || !city || !desc) return alert("Please fill all required fields marked with *");

        showLoading(true);

        try {
            let imageUrls = [];

            // 2. Upload Images first (if selected)
            if (imageInput.files.length > 0) {
                const formData = new FormData();
                for (let i = 0; i < imageInput.files.length; i++) {
                    formData.append('images', imageInput.files[i]);
                }

                const uploadRes = await fetch(`${API_URL}/upload`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                const uploadJson = await uploadRes.json();
                if (!uploadJson.success) throw new Error("Image upload failed");
                imageUrls = uploadJson.urls;
            }

            // 3. Save Property Data
            const propertyData = {
                title,
                price: Number(price),
                propertyType: type,
                status,
                description: desc,
                address: { city, state: "India" }, // Defaults
                features: { area: Number(area) || 0 },
                images: imageUrls,
                owner: { name: currentUser.name, email: currentUser.email, phone: "9999999999" } // Auto-fill owner
            };

            const res = await fetch(`${API_URL}/properties`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(propertyData)
            });

            const json = await res.json();
            if (!json.success) throw new Error(json.error);

            alert("Property Saved Successfully!");
            clearForm();
            loadProperties();

        } catch (err) {
            console.error(err);
            alert("Error: " + err.message);
        } finally {
            showLoading(false);
        }
    }

    async function deleteProperty(id) {
        if (!confirm("Are you sure you want to delete this property? This cannot be undone.")) return;
        
        const token = localStorage.getItem('token');
        showLoading(true);

        try {
            const res = await fetch(`${API_URL}/properties/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const json = await res.json();
            if (!json.success) throw new Error(json.error);
            
            loadProperties();
        } catch (err) {
            alert("Delete failed: " + err.message);
        } finally {
            showLoading(false);
        }
    }

    // --- HELPERS ---
    function showLoading(show) {
        document.getElementById('loading').style.display = show ? 'flex' : 'none';
        document.getElementById('saveBtn').disabled = show;
    }

    function clearForm() {
        document.getElementById('title').value = '';
        document.getElementById('price').value = '';
        document.getElementById('city').value = '';
        document.getElementById('description').value = '';
        document.getElementById('area').value = '';
        document.getElementById('imageFile').value = '';
    }
  </script>
</body>
</html>
