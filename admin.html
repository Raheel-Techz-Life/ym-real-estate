<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Dashboard - YM Real Estate</title>
  <style>
    body{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;margin:0;background:#f0f2f5;color:#1a1a1a}
    .wrap{max-width:1000px;margin:30px auto;padding:20px}
    h1{color:#2c3e50;margin-bottom:20px;border-bottom:2px solid #3498db;padding-bottom:10px}
    
    /* Login Warning */
    #auth-warning {display:none; text-align:center; padding:50px; background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1);}
    #admin-panel {display:none;}

    .form{background:#fff;padding:25px;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.05); margin-bottom:30px; border-left: 5px solid #3498db;}
    .form.editing {border-left-color: #f39c12; background: #fffdf6;} /* Yellow border when editing */

    .row{display:flex;gap:15px;margin-bottom:15px; flex-wrap:wrap;}
    .form-group {flex:1; min-width: 200px;}
    label{display:block; font-weight:600; margin-bottom:5px; color:#34495e;}
    input[type=text], input[type=number], select, textarea{
        width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box; font-size:14px;
    }
    textarea{min-height:100px; resize:vertical;}
    
    /* Buttons */
    .btn-group {text-align:right; display: flex; justify-content: flex-end; gap: 10px;}
    button{padding:12px 20px;border:0;border-radius:6px;cursor:pointer;font-weight:600;transition:0.2s;}
    
    .btn-primary {background:#3498db;color:#fff;}
    .btn-primary:hover{background:#2980b9;}
    
    .btn-cancel {background:#bdc3c7;color:#2c3e50; display:none;} /* Hidden by default */
    .btn-cancel:hover{background:#95a5a6;}

    .btn-edit {background:#f39c12; color:white; padding: 6px 12px; font-size: 13px;}
    .btn-delete {background:#e74c3c; color:white; padding: 6px 12px; font-size: 13px;}

    /* List Items */
    .list-header {display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;}
    .card{background:#fff;padding:15px;border-radius:8px;margin-bottom:15px;display:flex;gap:15px;align-items:center;box-shadow:0 2px 4px rgba(0,0,0,0.05);}
    .card img{width:100px;height:70px;object-fit:cover;border-radius:4px;background:#eee;}
    .meta{flex:1;}
    .meta h3 {margin:0 0 5px 0; font-size:16px;}
    .controls{display:flex;gap:10px;}

    .status {padding:4px 8px; border-radius:12px; font-size:12px; font-weight:bold;}
    .status.sale {background:#e8f8f5; color:#27ae60;}
    .status.rent {background:#fef9e7; color:#f1c40f;}

    /* Loading Spinner */
    #loading {position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:none; justify-content:center; align-items:center; z-index:999;}
    .spinner {border:4px solid #f3f3f3; border-top:4px solid #3498db; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite;}
    @keyframes spin {0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)}}
  </style>
</head>
<body>

  <div id="loading"><div class="spinner"></div></div>

  <div class="wrap">
    <div id="auth-warning">
      <h2>ðŸ”’ Admin Access Required</h2>
      <p>You must be logged in as an admin to view this page.</p>
      <button class="btn-primary" onclick="window.location.href='login.html'">Go to Login</button>
    </div>

    <div id="admin-panel">
      <h1>Admin Dashboard</h1>
      
      <div class="form" id="propertyFormCard">
        <h3 id="formTitle">Add New Property</h3>
        <div class="row">
            <div class="form-group">
                <label>Property Title*</label>
                <input id="title" type="text" placeholder="e.g. Luxury Villa in Goa">
            </div>
            <div class="form-group">
                <label>Price (â‚¹)*</label>
                <input id="price" type="number" placeholder="e.g. 25000000">
            </div>
        </div>

        <div class="row">
            <div class="form-group">
                <label>Type</label>
                <select id="propertyType">
                    <option value="Apartment">Apartment</option>
                    <option value="Villa">Villa</option>
                    <option value="Office">Office</option>
                    <option value="Land">Land</option>
                </select>
            </div>
            <div class="form-group">
                <label>Status</label>
                <select id="status">
                    <option value="sale">For Sale</option>
                    <option value="rent">For Rent</option>
                </select>
            </div>
        </div>

        <div class="row">
            <div class="form-group">
                <label>Location (City)*</label>
                <input id="city" type="text" placeholder="e.g. Mumbai">
            </div>
            <div class="form-group">
                <label>Area (Sq Ft)</label>
                <input id="area" type="number" placeholder="e.g. 1200">
            </div>
        </div>

        <div class="row">
            <div class="form-group">
                <label>Description*</label>
                <textarea id="description" placeholder="Full property details..."></textarea>
            </div>
        </div>

        <div class="row">
            <div class="form-group">
                <label>Image Upload</label>
                <input id="imageFile" type="file" accept="image/*" multiple>
                <small style="color:#7f8c8d" id="imageNote">Images (Max 10MB)</small>
            </div>
        </div>

        <div class="btn-group">
            <button id="cancelBtn" class="btn-cancel" onclick="resetForm()">Cancel Edit</button>
            <button id="saveBtn" class="btn-primary" onclick="saveProperty()">Save Property</button>
        </div>
      </div>

      <div class="list">
        <div class="list-header">
            <h2>Manage Listings</h2>
            <button onclick="loadProperties()" style="background:#95a5a6; padding:8px 12px; font-size:12px; color:white; border:none; border-radius:4px;">Refresh</button>
        </div>
        <div id="items">Loading properties...</div>
      </div>
    </div>
  </div>

  <script>
    // --- CONFIGURATION ---
    const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
        ? 'http://localhost:5011/api'  
        : 'https://ym-real-estate.onrender.com/api'; 

    // --- STATE ---
    let currentUser = null;
    let editingId = null; // Tells us if we are updating or creating

    // --- INITIALIZATION ---
    window.onload = checkAuth;

    function checkAuth() {
        const token = localStorage.getItem('token');
        const userStr = localStorage.getItem('user');
        
        if (!token || !userStr) {
            showLoginWarning();
            return;
        }

        try {
            currentUser = JSON.parse(userStr);
            if (currentUser.role !== 'admin' && currentUser.role !== 'team') {
                alert("Access Denied: You are not an admin.");
                window.location.href = 'index.html';
                return;
            }
            document.getElementById('auth-warning').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
            loadProperties();
        } catch (e) {
            showLoginWarning();
        }
    }

    function showLoginWarning() {
        document.getElementById('auth-warning').style.display = 'block';
        document.getElementById('admin-panel').style.display = 'none';
    }

    // --- API FUNCTIONS ---

    async function loadProperties() {
        const itemsEl = document.getElementById('items');
        itemsEl.innerHTML = '<p style="text-align:center; color:#777;">Fetching data...</p>';

        try {
            const res = await fetch(`${API_URL}/properties`);
            const json = await res.json();

            if (!json.success) throw new Error(json.error);

            itemsEl.innerHTML = '';
            if (json.data.length === 0) {
                itemsEl.innerHTML = '<p>No properties found.</p>';
                return;
            }

            json.data.forEach(p => {
                const div = document.createElement('div');
                div.className = 'card';
                const imgUrl = (p.images && p.images.length > 0) ? p.images[0] : 'https://via.placeholder.com/150';
                
                // Add the full object to the Edit button so we don't need another fetch
                // We encode it to safely pass it as a string
                const dataString = encodeURIComponent(JSON.stringify(p));

                div.innerHTML = `
                    <img src="${imgUrl}" alt="Property">
                    <div class="meta">
                        <h3>${p.title} <span class="status ${p.status}">${p.status.toUpperCase()}</span></h3>
                        <div class="note">â‚¹${p.price.toLocaleString()} â€¢ ${p.address.city}</div>
                    </div>
                    <div class="controls">
                        <button class="btn-edit" onclick="loadForEdit('${dataString}')">Edit</button>
                        <button class="btn-delete" onclick="deleteProperty('${p._id}')">Delete</button>
                    </div>
                `;
                itemsEl.appendChild(div);
            });
        } catch (err) {
            console.error(err);
            itemsEl.innerHTML = `<p style="color:red">Error loading properties: ${err.message}</p>`;
        }
    }

    // --- THE EDIT FUNCTION ---
    function loadForEdit(dataString) {
        const p = JSON.parse(decodeURIComponent(dataString));
        
        // 1. Set State
        editingId = p._id;

        // 2. Update UI to "Edit Mode"
        document.getElementById('formTitle').innerText = `Edit Property: ${p.title}`;
        document.getElementById('saveBtn').innerText = "Update Property";
        document.getElementById('cancelBtn').style.display = "inline-block";
        document.getElementById('propertyFormCard').classList.add('editing');
        document.getElementById('imageNote').innerText = "Leave empty to keep existing images";

        // 3. Fill Fields
        document.getElementById('title').value = p.title;
        document.getElementById('price').value = p.price;
        document.getElementById('propertyType').value = p.propertyType;
        document.getElementById('status').value = p.status;
        document.getElementById('city').value = p.address.city;
        document.getElementById('area').value = p.features.area;
        document.getElementById('description').value = p.description;

        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // --- RESET FORM ---
    function resetForm() {
        editingId = null;
        document.getElementById('formTitle').innerText = "Add New Property";
        document.getElementById('saveBtn').innerText = "Save Property";
        document.getElementById('cancelBtn').style.display = "none";
        document.getElementById('propertyFormCard').classList.remove('editing');
        document.getElementById('imageNote').innerText = "Images (Max 10MB)";
        
        // Clear inputs
        document.getElementById('title').value = '';
        document.getElementById('price').value = '';
        document.getElementById('city').value = '';
        document.getElementById('description').value = '';
        document.getElementById('area').value = '';
        document.getElementById('imageFile').value = '';
    }

    // --- SAVE (CREATE OR UPDATE) ---
    async function saveProperty() {
        const token = localStorage.getItem('token');
        if (!token) return alert("Session expired. Please login again.");

        // 1. Get Values
        const title = document.getElementById('title').value;
        const price = document.getElementById('price').value;
        const type = document.getElementById('propertyType').value;
        const status = document.getElementById('status').value;
        const city = document.getElementById('city').value;
        const desc = document.getElementById('description').value;
        const area = document.getElementById('area').value;
        const imageInput = document.getElementById('imageFile');

        if (!title || !price || !city || !desc) return alert("Please fill all required fields.");

        showLoading(true);

        try {
            let imageUrls = null; // Null means "don't change images"

            // 2. Handle Images (Only upload if new files selected)
            if (imageInput.files.length > 0) {
                const formData = new FormData();
                for (let i = 0; i < imageInput.files.length; i++) {
                    formData.append('images', imageInput.files[i]);
                }

                const uploadRes = await fetch(`${API_URL}/upload`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                const uploadJson = await uploadRes.json();
                if (!uploadJson.success) throw new Error("Image upload failed");
                imageUrls = uploadJson.urls;
            }

            // 3. Prepare Data
            const propertyData = {
                title,
                price: Number(price),
                propertyType: type,
                status,
                description: desc,
                address: { city, state: "India" },
                features: { area: Number(area) || 0 },
                owner: { name: currentUser.name, email: currentUser.email, phone: "9999999999" }
            };

            // If we have new images, add them. If not, don't send the key (Backend keeps old)
            if (imageUrls) {
                propertyData.images = imageUrls;
            }

            // 4. Send Request (POST for New, PUT for Edit)
            let url = `${API_URL}/properties`;
            let method = 'POST';

            if (editingId) {
                url = `${API_URL}/properties/${editingId}`;
                method = 'PUT';
            }

            const res = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(propertyData)
            });

            const json = await res.json();
            if (!json.success) throw new Error(json.error);

            alert(editingId ? "Property Updated!" : "Property Created!");
            resetForm();
            loadProperties();

        } catch (err) {
            console.error(err);
            alert("Error: " + err.message);
        } finally {
            showLoading(false);
        }
    }

    async function deleteProperty(id) {
        if (!confirm("Delete this property? This cannot be undone.")) return;
        
        const token = localStorage.getItem('token');
        showLoading(true);

        try {
            const res = await fetch(`${API_URL}/properties/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const json = await res.json();
            if (!json.success) throw new Error(json.error);
            
            // If we were editing this item, cancel the edit
            if (editingId === id) resetForm();
            
            loadProperties();
        } catch (err) {
            alert("Delete failed: " + err.message);
        } finally {
            showLoading(false);
        }
    }

    function showLoading(show) {
        document.getElementById('loading').style.display = show ? 'flex' : 'none';
        document.getElementById('saveBtn').disabled = show;
    }
  </script>
</body>
</html>
