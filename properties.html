<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Properties - Y M REAL ESTATE</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    /* --- CSS VARIABLES & RESET --- */
    :root {
      --primary: #263f6e;
      --light: #f6faff;
      --accent: #ffd700;
      --text: #2d3748;
      --border: #e2e8f0;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Poppins', sans-serif; background: var(--light); color: var(--text); padding-top: 80px; }

    /* --- HEADER --- */
    .header {
        background: rgba(255, 255, 255, 0.98);
        padding: 15px 30px; 
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        display: flex; align-items: center; justify-content: space-between;
        position: fixed; width: 100%; top: 0; left: 0; z-index: 1000;
    }
    .logo-area { display: flex; align-items: center; gap: 10px; text-decoration: none; color: var(--primary); font-weight: 700; font-size: 1.4rem; }
    .logo-area img { height: 45px; border-radius: 5px; }
    .nav { display: flex; gap: 20px; }
    .nav a { text-decoration: none; color: var(--text); font-weight: 500; transition: 0.2s; }
    .nav a:hover, .nav a.active { color: var(--primary); }

    /* --- FILTER BAR --- */
    .main-container { max-width: 1200px; margin: 40px auto; padding: 0 20px; }
    
    .filter-bar {
        background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 15px; align-items: end;
        margin-bottom: 30px; border: 1px solid var(--border);
    }

    .filter-group label { display: block; font-size: 0.85rem; font-weight: 600; color: #64748b; margin-bottom: 5px; }
    
    .filter-input, .filter-select {
        width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px;
        font-family: inherit; font-size: 0.95rem; outline: none; background: #f8fafc;
    }
    .filter-input:focus, .filter-select:focus { border-color: var(--primary); background: white; }

    .btn-reset {
        background: var(--primary); color: white; border: none; padding: 12px 20px;
        border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; height: 45px;
    }
    .btn-reset:hover { background: #1a2d4d; }

    /* --- PROPERTIES GRID --- */
    .properties-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 30px; }
    
    .prop-card {
        background: white; border-radius: 15px; overflow: hidden;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: transform 0.3s;
        border: 1px solid transparent; cursor: pointer;
    }
    .prop-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    
    .prop-img { height: 200px; width: 100%; object-fit: cover; background: #eee; }
    
    .prop-info { padding: 20px; }
    .prop-badge { 
        display: inline-block; padding: 4px 10px; background: #e2e8f0; 
        border-radius: 20px; font-size: 0.75rem; font-weight: 600; color: #4a5568; margin-bottom: 10px;
    }
    .prop-title { font-size: 1.1rem; font-weight: 700; color: var(--primary); margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .prop-loc { color: #718096; font-size: 0.9rem; margin-bottom: 15px; }
    .prop-price { font-size: 1.2rem; font-weight: 700; color: var(--accent); }

    /* --- LOADING & EMPTY STATES --- */
    .loading { text-align: center; grid-column: 1/-1; padding: 50px; color: #718096; }
    
    @media (max-width: 900px) {
        .filter-bar { grid-template-columns: 1fr; }
        .header { flex-direction: column; height: auto; padding: 15px; gap: 15px; }
        body { padding-top: 140px; }
    }
  </style>
</head>
<body>

  <div class="header">
    <a href="index.html" class="logo-area">
      <img src="ymr.jpg" onerror="this.src='https://placehold.co/50'" alt="Logo"> Y M REAL ESTATE
    </a>
    <div class="nav">
      <a href="index.html">Home</a>
      <a href="properties.html" class="active">Properties</a>
      <a href="team.html">Team</a>
      <a href="contact.html">Contact</a>
    </div>
  </div>

  <div class="main-container">
    <h1 style="color:var(--primary); margin-bottom:20px;">Find Your Property</h1>

    <div class="filter-bar">
        
        <div class="filter-group">
            <label><i class="fas fa-search"></i> Search</label>
            <input type="text" id="search" class="filter-input" placeholder="City, Locality or Title...">
        </div>

        <div class="filter-group">
            <label><i class="fas fa-home"></i> Type</label>
            <select id="typeFilter" class="filter-select">
                <option value="">All Types</option>
                <option value="House">House</option>
                <option value="Farmland">Farmlands</option>
                <option value="Plot">Plots</option>
                <option value="Shop">Shops</option>
                <option value="Villa">Villa</option>
                <option value="Apartment">Apartment</option>
            </select>
        </div>

        <div class="filter-group">
            <label><i class="fas fa-tag"></i> Status</label>
            <select id="statusFilter" class="filter-select">
                <option value="">Any Status</option>
                <option value="sale">For Sale</option>
                <option value="rent">For Rent</option>
            </select>
        </div>

        <div class="filter-group">
            <label><i class="fas fa-map-marker-alt"></i> City</label>
            <select id="cityFilter" class="filter-select">
                <option value="">All Cities</option>
                </select>
        </div>

        <button class="btn-reset" onclick="resetFilters()">Reset</button>
    </div>

    <div id="resultsCount" style="margin-bottom:15px; color:#666; font-size:0.9rem;"></div>
    <div class="properties-grid" id="grid">
        <div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading properties...</div>
    </div>

  </div>

  <script src="js/api.js"></script>
  <script>
    (() => {
        // CONFIG
        const API_URL = window.location.hostname === 'localhost' ? 'http://localhost:5011' : 'https://ym-real-estate.onrender.com';
        const API = `${API_URL}/api`;
        const UPLOADS = `${API_URL}/uploads/`;

        // STATE
        let allProps = [];

        // IMAGE HELPER
        const getImg = (path) => {
            if(!path) return 'https://placehold.co/600x400?text=No+Image';
            if(path.includes('http') && !path.includes('localhost')) return path;
            const file = path.split(/[/\\]/).pop();
            return `${UPLOADS}${file}`;
        };

        // LOAD DATA
        async function load() {
            try {
                const res = await fetch(`${API}/properties`);
                const json = await res.json();
                allProps = json.data || json;
                
                populateCities();
                checkUrlParams(); // Check if user came from search bar
                applyFilters();
            } catch(e) {
                document.getElementById('grid').innerHTML = '<div class="loading">Failed to load data.</div>';
                console.error(e);
            }
        }

        // POPULATE CITY DROPDOWN DYNAMICALLY
        function populateCities() {
            const cities = [...new Set(allProps.map(p => p.address?.city).filter(Boolean))].sort();
            const select = document.getElementById('cityFilter');
            cities.forEach(city => {
                const opt = document.createElement('option');
                opt.value = city;
                opt.textContent = city;
                select.appendChild(opt);
            });
        }

        // CHECK URL PARAMS (e.g. ?type=Farmland)
        function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const type = params.get('type');
            const search = params.get('search');

            if(type) document.getElementById('typeFilter').value = type;
            if(search) document.getElementById('search').value = search;
        }

        // FILTER LOGIC
        window.applyFilters = () => {
            const search = document.getElementById('search').value.toLowerCase();
            const type = document.getElementById('typeFilter').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;
            const city = document.getElementById('cityFilter').value;

            const filtered = allProps.filter(p => {
                const pType = (p.propertyType || '').toLowerCase();
                // Handle "Farmland" vs "Farmlands" (singular/plural matching)
                const typeMatch = !type || pType.includes(type) || type.includes(pType);
                
                const statusMatch = !status || p.status === status;
                const cityMatch = !city || (p.address?.city === city);
                const searchMatch = !search || 
                                    (p.title || '').toLowerCase().includes(search) || 
                                    (p.address?.city || '').toLowerCase().includes(search);

                return typeMatch && statusMatch && cityMatch && searchMatch;
            });

            render(filtered);
        };

        // RENDER GRID
        function render(props) {
            const grid = document.getElementById('grid');
            document.getElementById('resultsCount').textContent = `Showing ${props.length} properties`;

            if(props.length === 0) {
                grid.innerHTML = '<div class="loading">No properties found matching your filters.</div>';
                return;
            }

            grid.innerHTML = props.map(p => `
                <div class="prop-card" onclick="window.location.href='property-details.html?id=${p._id}'">
                    <img src="${getImg(p.images[0])}" class="prop-img" onerror="this.src='https://placehold.co/600x400'">
                    <div class="prop-info">
                        <div style="display:flex; justify-content:space-between;">
                            <span class="prop-badge">${p.propertyType}</span>
                            <span class="prop-badge" style="background:${p.status==='sale'?'#dcfce7':'#fef9c3'}; color:${p.status==='sale'?'#166534':'#854d0e'}">
                                ${p.status === 'sale' ? 'For Sale' : 'For Rent'}
                            </span>
                        </div>
                        <div class="prop-title">${p.title}</div>
                        <div class="prop-loc"><i class="fas fa-map-marker-alt"></i> ${p.address?.city}, ${p.address?.state}</div>
                        <div class="prop-price">â‚¹${Number(p.price).toLocaleString('en-IN')}</div>
                    </div>
                </div>
            `).join('');
        }

        window.resetFilters = () => {
            document.getElementById('search').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('cityFilter').value = '';
            applyFilters();
        };

        // EVENT LISTENERS
        ['search', 'typeFilter', 'statusFilter', 'cityFilter'].forEach(id => {
            document.getElementById(id).addEventListener('input', applyFilters);
        });

        load();
    })();
  </script>
</body>
</html>
